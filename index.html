<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Отзывы</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    max-width: 600px;
    margin: 30px auto;
    padding: 0 15px;
    background: #f9f9f9;
    color: #333;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  form {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
  }
  input[type="number"], textarea {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 15px;
    border: 1.5px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    resize: vertical;
  }
  input[type="number"] {
    max-width: 100px;
  }
  button {
    background: #4caf50;
    color: white;
    border: none;
    padding: 12px 25px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #45a049;
  }
  .error {
    color: #d93025;
    margin-bottom: 10px;
  }
  .success {
    color: #188038;
    margin-bottom: 10px;
  }
  .reviews-list {
    list-style: none;
    padding-left: 0;
  }
  .review-item {
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 0 6px rgba(0,0,0,0.05);
  }
  .review-rating {
    font-weight: 700;
    color: #4caf50;
    margin-bottom: 8px;
  }
  .review-text {
    white-space: pre-wrap;
    line-height: 1.4;
  }
</style>
</head>
<body>

<h1>Отзывы</h1>

<form id="reviewForm">
  <div id="message"></div>
  
  <label for="rating">Оценка (0.0 - 5.0):</label>
  <input
    type="number"
    id="rating"
    name="rating"
    min="0"
    max="5"
    step="0.1"
    required
  />
  
  <label for="text">Текст отзыва:</label>
  <textarea id="text" name="text" rows="5" maxlength="1000" required></textarea>
  
  <button type="submit">Отправить отзыв</button>
</form>

<ul class="reviews-list" id="reviewsList"></ul>

<script>
  const form = document.getElementById('reviewForm');
  const messageDiv = document.getElementById('message');
  const reviewsList = document.getElementById('reviewsList');

  // Функция для экранирования HTML в тексте
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
    }[m]));
  }

  // Загрузка и отображение отзывов
  async function loadReviews() {
    try {
      const res = await fetch('/reviews');
      if (!res.ok) throw new Error('Ошибка загрузки отзывов');
      const data = await res.json();
      reviewsList.innerHTML = '';
      if (data.length === 0) {
        reviewsList.innerHTML = '<li>Пока нет отзывов.</li>';
        return;
      }
      data.forEach(({ rating, text }) => {
        const li = document.createElement('li');
        li.className = 'review-item';
        li.innerHTML = `<div class="review-rating">Оценка: ${rating.toFixed(1)}</div><div class="review-text">${escapeHTML(text)}</div>`;
        reviewsList.appendChild(li);
      });
    } catch (e) {
      reviewsList.innerHTML = '<li>Не удалось загрузить отзывы.</li>';
      console.error(e);
    }
  }

  // Отправка отзыва
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.textContent = '';
    messageDiv.className = '';
    const rating = parseFloat(form.rating.value);
    const text = form.text.value.trim();

    // Простая валидация
    if (isNaN(rating) || rating < 0 || rating > 5) {
      messageDiv.textContent = 'Оценка должна быть от 0.0 до 5.0';
      messageDiv.className = 'error';
      return;
    }
    if (text.length === 0) {
      messageDiv.textContent = 'Введите текст отзыва';
      messageDiv.className = 'error';
      return;
    }

    form.querySelector('button').disabled = true;

    try {
      const res = await fetch('/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rating, text })
      });

      const data = await res.json();

      if (!res.ok) {
        messageDiv.textContent = data.error || 'Ошибка сервера';
        messageDiv.className = 'error';
      } else {
        messageDiv.textContent = 'Спасибо за отзыв!';
        messageDiv.className = 'success';
        form.reset();
        // После удачного отзыва блокируем форму — потому что сервер блокирует повторные по IP
        form.style.display = 'none';
      }
    } catch (err) {
      messageDiv.textContent = 'Ошибка сети, попробуйте позже';
      messageDiv.className = 'error';
    } finally {
      form.querySelector('button').disabled = false;
    }
  });

  // Загружаем отзывы при загрузке страницы
  loadReviews();
</script>

</body>
</html>
