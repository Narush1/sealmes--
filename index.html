<script>
  const form = document.getElementById('reviewForm');
  const messageDiv = document.getElementById('message');
  const reviewsList = document.getElementById('reviewsList');
  const averageRatingDiv = document.getElementById('averageRating');

  // Функция для экранирования HTML в тексте
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
    }[m]));
  }

  // Загрузка и отображение отзывов
  async function loadReviews() {
    try {
      const res = await fetch('/reviews');
      if (!res.ok) throw new Error('Ошибка загрузки отзывов');
      const data = await res.json();
      reviewsList.innerHTML = '';
      if (data.length === 0) {
        reviewsList.innerHTML = '<li>Пока нет отзывов.</li>';
        return;
      }
      data.forEach(({ rating, text }) => {
        const li = document.createElement('li');
        li.className = 'review-item';
        li.innerHTML = `<div class="review-rating">Оценка: ${rating.toFixed(1)}</div><div class="review-text">${escapeHTML(text)}</div>`;
        reviewsList.appendChild(li);
      });
    } catch (e) {
      reviewsList.innerHTML = '<li>Не удалось загрузить отзывы.</li>';
      console.error(e);
    }
  }

  // Загрузка и отображение средней оценки
  async function loadAverageRating() {
    try {
      const res = await fetch('/average-rating');
      if (!res.ok) throw new Error('Ошибка при загрузке средней оценки');
      const data = await res.json();
      const avg = data.average.toFixed(2);
      averageRatingDiv.textContent = `Средняя оценка: ${avg} / 5.0`;
    } catch {
      averageRatingDiv.textContent = 'Не удалось загрузить среднюю оценку';
    }
  }

  // Отправка отзыва
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.textContent = '';
    messageDiv.className = '';
    const rating = parseFloat(form.rating.value);
    const text = form.text.value.trim();

    // Простая валидация
    if (isNaN(rating) || rating < 0 || rating > 5) {
      messageDiv.textContent = 'Оценка должна быть от 0.0 до 5.0';
      messageDiv.className = 'error';
      return;
    }
    if (text.length === 0) {
      messageDiv.textContent = 'Введите текст отзыва';
      messageDiv.className = 'error';
      return;
    }

    form.querySelector('button').disabled = true;

    try {
      const res = await fetch('/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rating, text })
      });

      const data = await res.json();

      if (!res.ok) {
        messageDiv.textContent = data.error || 'Ошибка сервера';
        messageDiv.className = 'error';
      } else {
        messageDiv.textContent = 'Спасибо за отзыв!';
        messageDiv.className = 'success';
        form.reset();
        form.style.display = 'none'; // Блокируем повторную отправку
        // Обновляем отзывы и среднюю оценку
        loadReviews();
        loadAverageRating();
      }
    } catch (err) {
      messageDiv.textContent = 'Ошибка сети, попробуйте позже';
      messageDiv.className = 'error';
    } finally {
      form.querySelector('button').disabled = false;
    }
  });

  // При загрузке страницы
  loadReviews();
  loadAverageRating();
</script>
